import{r as l,z as U,s as d,A as S,B as u,j as e,W as J,D as K,R as V,L as X,e as P,P as Y,c as f,C as Z,E as ee,m as se,F as ae,G as te,H as re}from"./index-B0wSphca.js";import{M as O}from"./Modal-BWrzqEB0.js";import{P as ne}from"./plus-DQ_6ynAC.js";import{S as le}from"./search-CcVOZ1ut.js";import{C as ie}from"./clock-CcVJ5kkz.js";import{E as ce}from"./eye-5LXkXcb5.js";import{P as E}from"./pen-B-L-1BQG.js";const x={pending:{label:"In Attesa",icon:ie,color:"badge-warning",next:"preparing"},preparing:{label:"In Preparazione",icon:Z,color:"badge-info",next:"ready"},ready:{label:"Pronto",icon:f,color:"badge-success",next:"delivered"},delivered:{label:"Consegnato",icon:Y,color:"badge-success",next:null},cancelled:{label:"Annullato",icon:P,color:"badge-danger",next:null}},N={dine_in:"Tavolo",takeaway:"Asporto",delivery:"Domicilio"};function je(){const[T,F]=l.useState([]),[A,v]=l.useState(!0),[j,D]=l.useState(new Date().toISOString().split("T")[0]),[g,I]=l.useState("all"),[b,M]=l.useState(""),[a,y]=l.useState(null),[z,$]=l.useState([]),[L,o]=l.useState(!1),[_,R]=l.useState(!1),[B,h]=l.useState(!1),[w,q]=l.useState([]),[t,i]=l.useState({order_type:"dine_in",table_id:void 0,payment_method:"cash",customer_name:"",customer_phone:"",notes:"",smac_passed:!1,status:"pending"}),c=l.useCallback(async()=>{v(!0);try{const s=await U(j);F(s)}catch(s){console.error("Error loading orders:",s),d("Errore nel caricamento ordini","error")}finally{v(!1)}},[j]);l.useEffect(()=>{c()},[c]),l.useEffect(()=>{if(!S||!u)return;const s=u.channel("orders-realtime").on("postgres_changes",{event:"*",schema:"public",table:"orders"},r=>{console.log("Realtime update:",r),c()}).subscribe(r=>{console.log("Realtime status:",r),R(r==="SUBSCRIBED")});return()=>{u&&u.removeChannel(s)}},[c]);async function C(s){const r=x[s.status];if(r.next)try{await ae(s.id,r.next),d(`Ordine #${s.id} aggiornato`,"success"),c()}catch(m){console.error("Error updating order:",m),d("Errore nell'aggiornamento","error")}}async function W(s){if(confirm("Sei sicuro di voler eliminare questo ordine?"))try{await te(s),d("Ordine eliminato","success"),c()}catch(r){console.error("Error deleting order:",r),d("Errore nell'eliminazione","error")}}async function G(s){y(s);try{const r=await ee(s.id);$(r),o(!0)}catch(r){console.error("Error loading order items:",r),d("Errore nel caricamento dettagli","error")}}async function k(s){if(y(s),i({order_type:s.order_type,table_id:s.table_id,payment_method:s.payment_method,customer_name:s.customer_name||"",customer_phone:s.customer_phone||"",notes:s.notes||"",smac_passed:s.smac_passed,status:s.status}),w.length===0)try{const r=await se();q(r)}catch(r){console.error("Error loading tables:",r)}h(!0)}async function H(){if(a)try{await re(a.id,{order_type:t.order_type,table_id:t.order_type==="dine_in"?t.table_id:void 0,payment_method:t.payment_method,customer_name:t.customer_name||void 0,customer_phone:t.customer_phone||void 0,notes:t.notes||void 0,smac_passed:t.smac_passed,status:t.status}),d("Ordine modificato con successo","success"),h(!1),c()}catch(s){console.error("Error updating order:",s),d("Errore nella modifica","error")}}const p=T.filter(s=>{if(g!=="all"&&s.status!==g)return!1;if(b){const r=b.toLowerCase();return s.id.toString().includes(r)||s.customer_name?.toLowerCase().includes(r)||s.table_name?.toLowerCase().includes(r)}return!0}),Q={pending:p.filter(s=>s.status==="pending"),preparing:p.filter(s=>s.status==="preparing"),ready:p.filter(s=>s.status==="ready"),delivered:p.filter(s=>s.status==="delivered")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Ordini"}),e.jsx("p",{className:"text-dark-400 mt-1",children:"Gestisci gli ordini del ristorante"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[S&&e.jsx("div",{className:`flex items-center gap-2 px-3 py-2 rounded-xl text-sm ${_?"bg-emerald-500/20 text-emerald-400":"bg-amber-500/20 text-amber-400"}`,children:_?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Live"})]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Offline"})]})}),e.jsx("button",{onClick:c,className:"btn-secondary",children:e.jsx(V,{className:"w-5 h-5"})}),e.jsxs(X,{to:"/orders/new",className:"btn-primary",children:[e.jsx(ne,{className:"w-5 h-5"}),"Nuovo Ordine"]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1 max-w-xs",children:[e.jsx(le,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-dark-400"}),e.jsx("input",{type:"text",placeholder:"Cerca ordine...",value:b,onChange:s=>M(s.target.value),className:"input pl-10"})]}),e.jsx("input",{type:"date",value:j,onChange:s=>D(s.target.value),className:"input w-auto"}),e.jsxs("select",{value:g,onChange:s=>I(s.target.value),className:"select w-auto",children:[e.jsx("option",{value:"all",children:"Tutti gli stati"}),e.jsx("option",{value:"pending",children:"In Attesa"}),e.jsx("option",{value:"preparing",children:"In Preparazione"}),e.jsx("option",{value:"ready",children:"Pronto"}),e.jsx("option",{value:"delivered",children:"Consegnato"})]})]}),A?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4",children:["pending","preparing","ready","delivered"].map(s=>{const r=x[s],m=Q[s];return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r.icon,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:r.label})]}),e.jsx("span",{className:r.color,children:m.length})]}),e.jsx("div",{className:"p-4 space-y-3 max-h-[60vh] overflow-y-auto",children:m.length===0?e.jsx("p",{className:"text-dark-500 text-center py-4 text-sm",children:"Nessun ordine"}):m.map(n=>e.jsxs("div",{className:"bg-dark-900 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[n.session_id?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"font-semibold text-white",children:[n.table_name," - Comanda #",n.order_number||1]}),e.jsx("p",{className:"text-xs text-primary-400/70",children:"Conto Aperto"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"font-semibold text-white",children:["Ordine #",n.id]}),e.jsxs("p",{className:"text-sm text-dark-400",children:[N[n.order_type],n.table_name&&` - ${n.table_name}`]})]}),n.customer_name&&e.jsx("p",{className:"text-sm text-dark-400",children:n.customer_name})]}),e.jsxs("p",{className:"font-bold text-primary-400",children:["€",n.total.toFixed(2)]})]}),n.notes&&e.jsx("p",{className:"text-sm text-dark-400 bg-dark-800 p-2 rounded-lg",children:n.notes}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>G(n),className:"btn-ghost btn-sm flex-1",children:[e.jsx(ce,{className:"w-4 h-4"}),"Dettagli"]}),e.jsx("button",{onClick:()=>k(n),className:"btn-secondary btn-sm",title:"Modifica ordine",children:e.jsx(E,{className:"w-4 h-4"})})]}),r.next&&e.jsxs("button",{onClick:()=>C(n),className:"btn-success btn-sm w-full",children:[e.jsx(f,{className:"w-4 h-4"}),s==="pending"?"Prepara":s==="preparing"?"Pronto":"Consegna"]})]})]},n.id))})]},s)})}),e.jsx(O,{isOpen:L,onClose:()=>o(!1),title:a?.session_id?`${a.table_name} - Comanda #${a.order_number||1}`:`Ordine #${a?.id}`,size:"lg",children:a&&e.jsxs("div",{className:"space-y-4",children:[a.session_id&&e.jsx("div",{className:"bg-primary-500/10 border border-primary-500/30 rounded-xl p-3 text-center",children:e.jsxs("span",{className:"text-primary-400 font-medium",children:["Conto Aperto - Sessione #",a.session_id]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Tipo"}),e.jsx("p",{className:"font-medium text-white",children:N[a.order_type]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Stato"}),e.jsx("span",{className:x[a.status].color,children:x[a.status].label})]}),a.table_name&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Tavolo"}),e.jsx("p",{className:"font-medium text-white",children:a.table_name})]}),a.customer_name&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Cliente"}),e.jsx("p",{className:"font-medium text-white",children:a.customer_name})]}),!a.session_id&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Pagamento"}),e.jsx("p",{className:"font-medium text-white capitalize",children:a.payment_method==="cash"?"Contanti":a.payment_method==="card"?"Carta":"Online"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"SMAC"}),e.jsx("p",{className:"font-medium text-white",children:a.smac_passed?"Sì":"No"})]})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400 mb-2",children:"Prodotti"}),e.jsx("div",{className:"space-y-2",children:z.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-dark-900 rounded-xl",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-white",children:[s.quantity,"x ",s.menu_item_name]}),s.notes&&e.jsx("p",{className:"text-sm text-dark-400",children:s.notes})]}),e.jsxs("p",{className:"font-medium text-primary-400",children:["€",(s.price*s.quantity).toFixed(2)]})]},s.id))})]}),a.notes&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400 mb-2",children:"Note"}),e.jsx("p",{className:"p-3 bg-dark-900 rounded-xl text-white",children:a.notes})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-dark-700",children:[e.jsx("span",{className:"text-lg font-semibold text-white",children:"Totale"}),e.jsxs("span",{className:"text-2xl font-bold text-primary-400",children:["€",a.total.toFixed(2)]})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsxs("button",{onClick:()=>{o(!1),k(a)},className:"btn-secondary flex-1",children:[e.jsx(E,{className:"w-5 h-5"}),"Modifica"]}),x[a.status].next&&e.jsxs("button",{onClick:()=>{C(a),o(!1)},className:"btn-success flex-1",children:[e.jsx(f,{className:"w-5 h-5"}),"Avanza Stato"]}),e.jsx("button",{onClick:()=>{W(a.id),o(!1)},className:"btn-danger",children:e.jsx(P,{className:"w-5 h-5"})})]})]})}),e.jsx(O,{isOpen:B,onClose:()=>h(!1),title:`Modifica Ordine #${a?.id}`,size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Tipo Ordine"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:["dine_in","takeaway","delivery"].map(s=>e.jsx("button",{type:"button",onClick:()=>i({...t,order_type:s}),className:`p-3 rounded-xl border-2 transition-all ${t.order_type===s?"border-primary-500 bg-primary-500/20 text-primary-400":"border-dark-600 hover:border-dark-500 text-dark-300"}`,children:N[s]},s))})]}),t.order_type==="dine_in"&&e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Tavolo"}),e.jsxs("select",{value:t.table_id||"",onChange:s=>i({...t,table_id:s.target.value?Number(s.target.value):void 0}),className:"select",children:[e.jsx("option",{value:"",children:"Seleziona tavolo"}),w.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.capacity," posti)"]},s.id))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nome Cliente"}),e.jsx("input",{type:"text",value:t.customer_name,onChange:s=>i({...t,customer_name:s.target.value}),className:"input",placeholder:"Nome cliente"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Telefono"}),e.jsx("input",{type:"tel",value:t.customer_phone,onChange:s=>i({...t,customer_phone:s.target.value}),className:"input",placeholder:"Telefono"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Metodo Pagamento"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:["cash","card","online"].map(s=>e.jsx("button",{type:"button",onClick:()=>i({...t,payment_method:s}),className:`p-3 rounded-xl border-2 transition-all ${t.payment_method===s?"border-primary-500 bg-primary-500/20 text-primary-400":"border-dark-600 hover:border-dark-500 text-dark-300"}`,children:s==="cash"?"Contanti":s==="card"?"Carta":"Online"},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Stato Ordine"}),e.jsxs("select",{value:t.status,onChange:s=>i({...t,status:s.target.value}),className:"select",children:[e.jsx("option",{value:"pending",children:"In Attesa"}),e.jsx("option",{value:"preparing",children:"In Preparazione"}),e.jsx("option",{value:"ready",children:"Pronto"}),e.jsx("option",{value:"delivered",children:"Consegnato"}),e.jsx("option",{value:"cancelled",children:"Annullato"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"smac_edit",checked:t.smac_passed,onChange:s=>i({...t,smac_passed:s.target.checked}),className:"w-5 h-5 rounded border-dark-600 text-primary-500 focus:ring-primary-500"}),e.jsx("label",{htmlFor:"smac_edit",className:"text-white cursor-pointer",children:"SMAC Passata"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Note"}),e.jsx("textarea",{value:t.notes,onChange:s=>i({...t,notes:s.target.value}),className:"input min-h-[80px]",placeholder:"Note aggiuntive..."})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsx("button",{onClick:H,className:"btn-primary flex-1",children:"Salva Modifiche"}),e.jsx("button",{onClick:()=>h(!1),className:"btn-secondary",children:"Annulla"})]})]})})]})}export{je as Orders};
