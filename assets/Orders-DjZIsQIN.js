import{r as n,o as U,s as d,p as S,q as u,j as e,W as J,t as K,R as V,L as X,e as P,P as Y,c as v,C as Z,v as ee,l as se,w as ae,x as te,y as re}from"./index-Cz_yVV27.js";import{M as O}from"./Modal-Bbnojc4l.js";import{P as ne}from"./plus-B0nDB6-u.js";import{S as le}from"./search-CL8Wmz8E.js";import{C as ie}from"./clock-DwT6Lqx9.js";import{E as ce}from"./eye-Dj0IWe1T.js";import{P as E}from"./pen-laJYx9TF.js";const x={pending:{label:"In Attesa",icon:ie,color:"badge-warning",next:"preparing"},preparing:{label:"In Preparazione",icon:Z,color:"badge-info",next:"ready"},ready:{label:"Pronto",icon:v,color:"badge-success",next:"delivered"},delivered:{label:"Consegnato",icon:Y,color:"badge-success",next:null},cancelled:{label:"Annullato",icon:P,color:"badge-danger",next:null}},f={dine_in:"Tavolo",takeaway:"Asporto",delivery:"Domicilio"};function je(){const[T,I]=n.useState([]),[M,N]=n.useState(!0),[j,D]=n.useState(new Date().toISOString().split("T")[0]),[g,A]=n.useState("all"),[b,F]=n.useState(""),[r,y]=n.useState(null),[z,L]=n.useState([]),[R,o]=n.useState(!1),[_,$]=n.useState(!1),[q,h]=n.useState(!1),[w,B]=n.useState([]),[a,i]=n.useState({order_type:"dine_in",table_id:void 0,payment_method:"cash",customer_name:"",customer_phone:"",notes:"",smac_passed:!1,status:"pending"}),c=n.useCallback(async()=>{N(!0);try{const s=await U(j);I(s)}catch(s){console.error("Error loading orders:",s),d("Errore nel caricamento ordini","error")}finally{N(!1)}},[j]);n.useEffect(()=>{c()},[c]),n.useEffect(()=>{if(!S||!u)return;const s=u.channel("orders-realtime").on("postgres_changes",{event:"*",schema:"public",table:"orders"},t=>{console.log("Realtime update:",t),c()}).subscribe(t=>{console.log("Realtime status:",t),$(t==="SUBSCRIBED")});return()=>{u&&u.removeChannel(s)}},[c]);async function C(s){const t=x[s.status];if(t.next)try{await ae(s.id,t.next),d(`Ordine #${s.id} aggiornato`,"success"),c()}catch(m){console.error("Error updating order:",m),d("Errore nell'aggiornamento","error")}}async function W(s){if(confirm("Sei sicuro di voler eliminare questo ordine?"))try{await te(s),d("Ordine eliminato","success"),c()}catch(t){console.error("Error deleting order:",t),d("Errore nell'eliminazione","error")}}async function Q(s){y(s);try{const t=await ee(s.id);L(t),o(!0)}catch(t){console.error("Error loading order items:",t),d("Errore nel caricamento dettagli","error")}}async function k(s){if(y(s),i({order_type:s.order_type,table_id:s.table_id,payment_method:s.payment_method,customer_name:s.customer_name||"",customer_phone:s.customer_phone||"",notes:s.notes||"",smac_passed:s.smac_passed,status:s.status}),w.length===0)try{const t=await se();B(t)}catch(t){console.error("Error loading tables:",t)}h(!0)}async function G(){if(r)try{await re(r.id,{order_type:a.order_type,table_id:a.order_type==="dine_in"?a.table_id:void 0,payment_method:a.payment_method,customer_name:a.customer_name||void 0,customer_phone:a.customer_phone||void 0,notes:a.notes||void 0,smac_passed:a.smac_passed,status:a.status}),d("Ordine modificato con successo","success"),h(!1),c()}catch(s){console.error("Error updating order:",s),d("Errore nella modifica","error")}}const p=T.filter(s=>{if(g!=="all"&&s.status!==g)return!1;if(b){const t=b.toLowerCase();return s.id.toString().includes(t)||s.customer_name?.toLowerCase().includes(t)||s.table_name?.toLowerCase().includes(t)}return!0}),H={pending:p.filter(s=>s.status==="pending"),preparing:p.filter(s=>s.status==="preparing"),ready:p.filter(s=>s.status==="ready"),delivered:p.filter(s=>s.status==="delivered")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Ordini"}),e.jsx("p",{className:"text-dark-400 mt-1",children:"Gestisci gli ordini del ristorante"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[S&&e.jsx("div",{className:`flex items-center gap-2 px-3 py-2 rounded-xl text-sm ${_?"bg-emerald-500/20 text-emerald-400":"bg-amber-500/20 text-amber-400"}`,children:_?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Live"})]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Offline"})]})}),e.jsx("button",{onClick:c,className:"btn-secondary",children:e.jsx(V,{className:"w-5 h-5"})}),e.jsxs(X,{to:"/orders/new",className:"btn-primary",children:[e.jsx(ne,{className:"w-5 h-5"}),"Nuovo Ordine"]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1 max-w-xs",children:[e.jsx(le,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-dark-400"}),e.jsx("input",{type:"text",placeholder:"Cerca ordine...",value:b,onChange:s=>F(s.target.value),className:"input pl-10"})]}),e.jsx("input",{type:"date",value:j,onChange:s=>D(s.target.value),className:"input w-auto"}),e.jsxs("select",{value:g,onChange:s=>A(s.target.value),className:"select w-auto",children:[e.jsx("option",{value:"all",children:"Tutti gli stati"}),e.jsx("option",{value:"pending",children:"In Attesa"}),e.jsx("option",{value:"preparing",children:"In Preparazione"}),e.jsx("option",{value:"ready",children:"Pronto"}),e.jsx("option",{value:"delivered",children:"Consegnato"})]})]}),M?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4",children:["pending","preparing","ready","delivered"].map(s=>{const t=x[s],m=H[s];return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t.icon,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:t.label})]}),e.jsx("span",{className:t.color,children:m.length})]}),e.jsx("div",{className:"p-4 space-y-3 max-h-[60vh] overflow-y-auto",children:m.length===0?e.jsx("p",{className:"text-dark-500 text-center py-4 text-sm",children:"Nessun ordine"}):m.map(l=>e.jsxs("div",{className:"bg-dark-900 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-white",children:["Ordine #",l.id]}),e.jsxs("p",{className:"text-sm text-dark-400",children:[f[l.order_type],l.table_name&&` - ${l.table_name}`]}),l.customer_name&&e.jsx("p",{className:"text-sm text-dark-400",children:l.customer_name})]}),e.jsxs("p",{className:"font-bold text-primary-400",children:["€",l.total.toFixed(2)]})]}),l.notes&&e.jsx("p",{className:"text-sm text-dark-400 bg-dark-800 p-2 rounded-lg",children:l.notes}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>Q(l),className:"btn-ghost btn-sm flex-1",children:[e.jsx(ce,{className:"w-4 h-4"}),"Dettagli"]}),e.jsx("button",{onClick:()=>k(l),className:"btn-secondary btn-sm",title:"Modifica ordine",children:e.jsx(E,{className:"w-4 h-4"})}),t.next&&e.jsxs("button",{onClick:()=>C(l),className:"btn-success btn-sm flex-1",children:[e.jsx(v,{className:"w-4 h-4"}),s==="pending"?"Prepara":s==="preparing"?"Pronto":"Consegna"]})]})]},l.id))})]},s)})}),e.jsx(O,{isOpen:R,onClose:()=>o(!1),title:`Ordine #${r?.id}`,size:"lg",children:r&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Tipo"}),e.jsx("p",{className:"font-medium text-white",children:f[r.order_type]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Stato"}),e.jsx("span",{className:x[r.status].color,children:x[r.status].label})]}),r.table_name&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Tavolo"}),e.jsx("p",{className:"font-medium text-white",children:r.table_name})]}),r.customer_name&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Cliente"}),e.jsx("p",{className:"font-medium text-white",children:r.customer_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Pagamento"}),e.jsx("p",{className:"font-medium text-white capitalize",children:r.payment_method==="cash"?"Contanti":r.payment_method==="card"?"Carta":"Online"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400",children:"SMAC"}),e.jsx("p",{className:"font-medium text-white",children:r.smac_passed?"Sì":"No"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400 mb-2",children:"Prodotti"}),e.jsx("div",{className:"space-y-2",children:z.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-dark-900 rounded-xl",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-white",children:[s.quantity,"x ",s.menu_item_name]}),s.notes&&e.jsx("p",{className:"text-sm text-dark-400",children:s.notes})]}),e.jsxs("p",{className:"font-medium text-primary-400",children:["€",(s.price*s.quantity).toFixed(2)]})]},s.id))})]}),r.notes&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-dark-400 mb-2",children:"Note"}),e.jsx("p",{className:"p-3 bg-dark-900 rounded-xl text-white",children:r.notes})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-dark-700",children:[e.jsx("span",{className:"text-lg font-semibold text-white",children:"Totale"}),e.jsxs("span",{className:"text-2xl font-bold text-primary-400",children:["€",r.total.toFixed(2)]})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsxs("button",{onClick:()=>{o(!1),k(r)},className:"btn-secondary flex-1",children:[e.jsx(E,{className:"w-5 h-5"}),"Modifica"]}),x[r.status].next&&e.jsxs("button",{onClick:()=>{C(r),o(!1)},className:"btn-success flex-1",children:[e.jsx(v,{className:"w-5 h-5"}),"Avanza Stato"]}),e.jsx("button",{onClick:()=>{W(r.id),o(!1)},className:"btn-danger",children:e.jsx(P,{className:"w-5 h-5"})})]})]})}),e.jsx(O,{isOpen:q,onClose:()=>h(!1),title:`Modifica Ordine #${r?.id}`,size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Tipo Ordine"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:["dine_in","takeaway","delivery"].map(s=>e.jsx("button",{type:"button",onClick:()=>i({...a,order_type:s}),className:`p-3 rounded-xl border-2 transition-all ${a.order_type===s?"border-primary-500 bg-primary-500/20 text-primary-400":"border-dark-600 hover:border-dark-500 text-dark-300"}`,children:f[s]},s))})]}),a.order_type==="dine_in"&&e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Tavolo"}),e.jsxs("select",{value:a.table_id||"",onChange:s=>i({...a,table_id:s.target.value?Number(s.target.value):void 0}),className:"select",children:[e.jsx("option",{value:"",children:"Seleziona tavolo"}),w.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.capacity," posti)"]},s.id))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Nome Cliente"}),e.jsx("input",{type:"text",value:a.customer_name,onChange:s=>i({...a,customer_name:s.target.value}),className:"input",placeholder:"Nome cliente"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Telefono"}),e.jsx("input",{type:"tel",value:a.customer_phone,onChange:s=>i({...a,customer_phone:s.target.value}),className:"input",placeholder:"Telefono"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Metodo Pagamento"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:["cash","card","online"].map(s=>e.jsx("button",{type:"button",onClick:()=>i({...a,payment_method:s}),className:`p-3 rounded-xl border-2 transition-all ${a.payment_method===s?"border-primary-500 bg-primary-500/20 text-primary-400":"border-dark-600 hover:border-dark-500 text-dark-300"}`,children:s==="cash"?"Contanti":s==="card"?"Carta":"Online"},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Stato Ordine"}),e.jsxs("select",{value:a.status,onChange:s=>i({...a,status:s.target.value}),className:"select",children:[e.jsx("option",{value:"pending",children:"In Attesa"}),e.jsx("option",{value:"preparing",children:"In Preparazione"}),e.jsx("option",{value:"ready",children:"Pronto"}),e.jsx("option",{value:"delivered",children:"Consegnato"}),e.jsx("option",{value:"cancelled",children:"Annullato"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"smac_edit",checked:a.smac_passed,onChange:s=>i({...a,smac_passed:s.target.checked}),className:"w-5 h-5 rounded border-dark-600 text-primary-500 focus:ring-primary-500"}),e.jsx("label",{htmlFor:"smac_edit",className:"text-white cursor-pointer",children:"SMAC Passata"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Note"}),e.jsx("textarea",{value:a.notes,onChange:s=>i({...a,notes:s.target.value}),className:"input min-h-[80px]",placeholder:"Note aggiuntive..."})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[e.jsx("button",{onClick:G,className:"btn-primary flex-1",children:"Salva Modifiche"}),e.jsx("button",{onClick:()=>h(!1),className:"btn-secondary",children:"Annulla"})]})]})})]})}export{je as Orders};
